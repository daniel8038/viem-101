# EIP-7702

这一讲对我来说也是学习，在登链社区有对 EIP-7702 更好的更全面的知识讲述。

这是我参考的原文：
[登链社区 EIP-7702 文章](https://learnblockchain.cn/article/15774)

简单来说，EIP-7702 使 EOA 临时获得智能合约的能力。

# 委托机制

总结上边的登链社区的文章：
EOA 委托智能合约，当别人与你的 EOA 交互，就是和这个被委托的智能合约交互，就要执行这个合约的代码。

委托过程涉及创建指向你选择的实现合约的授权签名。一旦此授权在链上处理完毕，你的 EOA 的代码槽将包含一个特殊的委托指示符，该指示符将执行重定向到目标合约。这是原文中的话，很好理解，就像是 EOA 里存了一个指针，指针指向委托合约。

文章里给了 委托指示符的格式

文章中也指出，委托需要明确的撤销或者更改，否则会一直保持活跃状态

# 交易构建

tx 结构中的 to 字段设置为 EOA 账户

# 授权 nonce

EIP-7702 的执行顺序：

1. 交易执行：使用当前 nonce (例如：5)
2. 处理授权：验证授权 nonce 是否等于当前 nonce + 1 (6)
3. 设置委托代码：0xef0100 || address
4. 增加账户 nonce：账户 nonce 增加 1

也就是说在发送交易这一步有一个 nonce 这个是 viem 自己管理，那这笔交易里面会涉及到其他的交易，这些 nonce 需要自己管理 提前指定，防止重访攻击

# 实操

这一次使用 env 配置下，涉及到的隐私性的东西比较多

安装 dotnev`npm i dotenv`

按照他的文章配置环境变量，记得把.env 写进 .gitignore 文件

根据文章可以了解到，发送一笔 Eip7702 的交易的必要步骤：

1. 通过`getCode({address:eoa.address})`检查地址是否已经创建委托
2. 如果没有，则为 EOA 创建授权
